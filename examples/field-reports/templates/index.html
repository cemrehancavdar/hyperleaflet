{% extends "base.html" %}

{% block content %}
<div id="map" style="height:45vh;width:100%" data-center="[39.0, 32.0]" data-zoom="6">
  <div data-tile="OpenStreetMap" data-default-tile></div>
</div>

<div class="d-flex align-items-center px-3 py-1 border-bottom">
  <select id="category-filter" class="form-select form-select-sm" style="width:auto" onchange="applyFilter(this.value)">
    <option value="all">All</option>
    {% for cat in categories %}
    <option value="{{ cat }}">{{ cat | title }}</option>
    {% endfor %}
  </select>
  <span class="text-secondary ms-auto small" id="report-count">{{ reports | length }}</span>
</div>

<div class="table-responsive">
  <table class="table table-vcenter table-nowrap table-sm mb-0" data-hyperleaflet-source>
        <thead>
          <tr><th>Name</th><th>Category</th><th>Notes</th><th>Coordinates</th><th class="w-1"></th></tr>
        </thead>
        <tbody id="report-list">
          {% for report in reports %}
          {% include "partials/report_row.html" %}
          {% endfor %}
        </tbody>
        <tfoot>
          <tr id="create-row">
            <td><input type="text" id="cr-name" class="form-control form-control-sm" placeholder="Name"></td>
            <td>
              <select id="cr-category" class="form-select form-select-sm">
                {% for cat in all_categories %}<option value="{{ cat }}">{{ cat | title }}</option>{% endfor %}
              </select>
            </td>
            <td><input type="text" id="cr-notes" class="form-control form-control-sm" placeholder="Notes"></td>
            <td><span class="text-secondary small" id="cr-coords">click map</span><input type="hidden" id="cr-lat"><input type="hidden" id="cr-lng"></td>
            <td><button id="create-btn" class="btn btn-primary btn-sm" onclick="submitCreate()" disabled>Add</button></td>
          </tr>
        </tfoot>
      </table>
</div>
{% endblock %}

{% block scripts %}
<script>
  var mapEl = document.getElementById('map');
  var pickMarker = null;
  var activeMarkerEl = null;

  (function poll() {
    if (mapEl.classList.contains('leaflet-container')) mapEl.classList.add('pick-mode');
    else setTimeout(poll, 100);
  })();

  window.addEventListener('map:click', function(e) {
    var lat = e.detail.point.lat, lng = e.detail.point.lng;
    var editLat = document.querySelector('tr.editing input[name="lat"]');
    if (editLat) {
      editLat.value = lat.toFixed(6);
      document.querySelector('tr.editing input[name="lng"]').value = lng.toFixed(6);
    } else {
      document.getElementById('cr-lat').value = lat.toFixed(6);
      document.getElementById('cr-lng').value = lng.toFixed(6);
      document.getElementById('cr-coords').textContent = lat.toFixed(4) + ', ' + lng.toFixed(4);
      document.getElementById('create-btn').disabled = false;
    }
    var map = window.hyperleaflet.map;
    if (pickMarker) map.removeLayer(pickMarker);
    pickMarker = L.circleMarker([lat, lng], {
      radius: 6, color: '#206bc4', fillOpacity: 0.3, weight: 2, dashArray: '4 4'
    }).addTo(map);
  });

  function submitCreate() {
    var name = document.getElementById('cr-name').value.trim();
    var lat = document.getElementById('cr-lat').value;
    var lng = document.getElementById('cr-lng').value;
    if (!name || !lat || !lng) return;
    var body = new URLSearchParams({
      name: name, category: document.getElementById('cr-category').value,
      notes: document.getElementById('cr-notes').value.trim(), lat: lat, lng: lng
    });
    fetch('/reports', { method: 'POST', body: body })
      .then(function(r) { return r.text(); })
      .then(function(html) {
        document.getElementById('report-list').insertAdjacentHTML('afterbegin', html);
        document.getElementById('cr-name').value = '';
        document.getElementById('cr-notes').value = '';
        document.getElementById('cr-lat').value = '';
        document.getElementById('cr-lng').value = '';
        document.getElementById('cr-coords').textContent = 'click map';
        document.getElementById('create-btn').disabled = true;
        if (pickMarker) { window.hyperleaflet.map.removeLayer(pickMarker); pickMarker = null; }
        updateCount(); showToast('Added', 'success');
      });
  }

  function startEdit(btn) {
    var row = btn.closest('tr'), id = row.dataset.id;
    fetch('/reports/' + id + '/edit')
      .then(function(r) { return r.text(); })
      .then(function(html) { row.style.display = 'none'; row.insertAdjacentHTML('afterend', html); });
  }
  function cancelEdit(btn) {
    var editRow = btn.closest('tr.editing');
    var orig = document.querySelector('tr[data-id="' + editRow.dataset.editFor + '"]');
    if (orig) orig.style.display = '';
    editRow.remove();
  }
  function saveEdit(btn) {
    var editRow = btn.closest('tr.editing'), id = editRow.dataset.editFor;
    var body = new URLSearchParams({
      name: editRow.querySelector('[name="name"]').value.trim(),
      category: editRow.querySelector('[name="category"]').value,
      notes: editRow.querySelector('[name="notes"]').value.trim(),
      lat: editRow.querySelector('[name="lat"]').value,
      lng: editRow.querySelector('[name="lng"]').value
    });
    if (!body.get('name') || !body.get('lat') || !body.get('lng')) return;
    fetch('/reports/' + id, { method: 'PUT', body: body })
      .then(function(r) { return r.text(); })
      .then(function(html) {
        var orig = document.querySelector('tr[data-id="' + id + '"]');
        if (orig) orig.remove();
        setTimeout(function() {
          editRow.insertAdjacentHTML('afterend', html);
          editRow.remove();
          updateCount(); showToast('Updated', 'success');
        }, 0);
      });
  }

  function deleteReport(btn) {
    var row = btn.closest('tr');
    if (!confirm("Delete '" + row.querySelector('td').textContent.trim() + "'?")) return;
    fetch('/reports/' + row.dataset.id, { method: 'DELETE' })
      .then(function() { row.remove(); updateCount(); showToast('Deleted', 'warning'); });
  }

  function applyFilter(cat) {
    document.querySelectorAll('#report-list tr[data-id]').forEach(function(row) {
      row.classList.toggle('filtered-out', cat !== 'all' && row.dataset.category !== cat);
    });
    updateCount();
  }
  function updateCount() {
    document.getElementById('report-count').textContent =
      document.querySelectorAll('#report-list tr[data-id]:not(.filtered-out)').length + ' reports';
  }

  function findMarker(id) {
    var layers = Object.values(window.hyperleaflet.map._layers);
    for (var i = 0; i < layers.length; i++) if (layers[i].hlID === id) return layers[i];
    return null;
  }
  function highlightReport(row) {
    if (event.target.closest('button') || event.target.closest('a')) return;
    var id = row.dataset.id, geom = JSON.parse(row.dataset.geometry);
    window.hyperleaflet.flyTo(geom, Math.max(window.hyperleaflet.getZoom(), 8));
    var m = findMarker(id);
    if (m) { setActiveMarker(m); m.openPopup(); }
    setActiveRow(id);
  }
  window.addEventListener('geometry:click', function(e) {
    var m = findMarker(e.detail.id);
    if (m) setActiveMarker(m);
    setActiveRow(e.detail.id);
  });
  function setActiveMarker(m) {
    if (activeMarkerEl) activeMarkerEl.classList.remove('active-marker-icon');
    if (m && m._icon) { m._icon.classList.add('active-marker-icon'); activeMarkerEl = m._icon; }
  }
  function setActiveRow(id) {
    document.querySelectorAll('tr.row-active').forEach(function(r) { r.classList.remove('row-active'); });
    var row = document.querySelector('tr[data-id="' + id + '"]');
    if (row) { row.classList.add('row-active'); row.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
    setTimeout(function() { if (row) row.classList.remove('row-active'); }, 2000);
  }
</script>
{% endblock %}
