!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("leaflet")):"function"==typeof define&&define.amd?define(["exports","leaflet"],t):t((e||self).hyperleaflet={},e.leaflet)}(this,function(e,t){function r(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(r){if("default"!==r){var o=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,o.get?o:{enumerable:!0,get:function(){return e[r]}})}}),t.default=e,t}var o=/*#__PURE__*/r(t);function n(){return n=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},n.apply(this,arguments)}var a={events:{},observe:function(e){var t=e.targetSelector,r=e.uniqueAttribute,o=e.attributeFilter;if(this.events[t])throw new Error("Can't observer twice");!function(e,t,r){var o=new MutationObserver(function(o){var u,d,l=[],c=[];o.forEach(function(r){if("childList"===r.type)l.push.apply(l,s(r.removedNodes)),c.push.apply(c,s(r.addedNodes));else if("attributes"===r.type){var o,i=r.attributeName,u=((o={attribute:i,from:r.oldValue,to:r.target.getAttribute(i)})[t]=r.target.getAttribute(t),o),d=[n({dataset:r.target.dataset},u)];d.length&&a.publish(e,"node_changes",d)}});var f=[],p=new Map(l.map(function(e){return[e.getAttribute(t),e]})),h=new Set;c.forEach(function(e){var o=e.getAttribute(t),a=p.get(o);if(a&&h.add(o),a&&!i(a,e,r)){var s=r.reduce(function(r,n){var i,s=a.getAttribute(n),u=e.getAttribute(n);return s!==u&&r.push(((i={attribute:n,from:s,to:u})[t]=o,i)),r},[]);f.push(n({},s,{dataset:e.dataset}))}});var y=null!=(u=l.filter(function(e){return!h.has(e.getAttribute(t))}))?u:[],m=null!=(d=c.filter(function(e){return!h.has(e.getAttribute(t))}))?d:[];m.length&&a.publish(e,"node_adds",m),f.length&&a.publish(e,"node_changes",f),y.length&&a.publish(e,"node_removes",y)}),i=function(e,t,r){return r.every(function(r){return e.getAttribute(r)===t.getAttribute(r)})};function s(e){var r=[];return e.forEach(function(e){1===e.nodeType&&(e.hasAttribute(t)&&r.push(e),r.push.apply(r,s(null==e?void 0:e.childNodes)))}),r}var u={childList:!0,subtree:!0,attributes:!0,attributeFilter:r,attributeOldValue:!0},d=document.querySelector(e);o.observe(d,u)}(t,r,o),this.events[t]={}},subscribe:function(e,t,r){this.events[e][t]=this.events[e][t]||[],this.events[e][t].push(r)},unsubscribe:function(e,t,r){this.events[e][t]&&(this.events[e][t]=this.events[e][t].filter(function(e){return e!==r}))},publish:function(e,t,r){this.events[e][t]&&this.events[e][t].forEach(function(e){e(r)})}};function i(e){return e&&"object"==typeof e&&!Array.isArray(e)}function s(e,t){var r=n({},e);return i(e)&&i(t)&&Object.keys(t).forEach(function(o){var n,a;i(t[o])?o in e?r[o]=s(e[o],t[o]):Object.assign(r,((n={})[o]=t[o],n)):Object.assign(r,((a={})[o]=t[o],a))}),r}window.pubsub=a;var u={reverseCoordinateOrder:!1,mapElement:"#map",events:{map:{target:"window",mouse:["click"],state:["zoom","move"],extra:["ready"]},geometry:{target:"window",mouse:["click"],state:["add"]},hyperleaflet:{target:"window",state:["ready"]}},styles:{}},d={_options:u,get options(){return this._options},set options(e){this._options=s(this._options,e)},reset:function(){this._options=u},getTarget:function(e){var t=this.options.events[e].target;switch(t){case"window":return window;case"document":return document;case"map":return this.options.mapElement;case"hyperleaflet":return document.querySelector("[data-hyperleaflet-source]");default:return document.querySelector(t)}}};function l(e,t,r){var o=e.getBounds(),n=o.getSouthWest(),a=o.getNorthEast(),i=o.toBBoxString();return new CustomEvent(t,{detail:{zoom:e.getZoom(),center:e.getCenter(),bbox:{min:n,max:a},bboxString:i,_leafletEvent:r}})}function c(e,t){void 0===t&&(t=!1);try{var r=JSON.parse(e);return t?function(e){return e.reverse()}(r):r}catch(e){return[0,0]}}var f={map:null,create:function(e){var t=e.dataset,r=t.zoom,n=t.minZoom,a=t.maxZoom,i={center:c(t.center,d.options.reverseCoordinateOrder),zoom:r||1},s=o.map(e,{center:i.center,zoom:i.zoom,minZoom:n||0,maxZoom:a||18});return function(e){var t=d.getTarget("map"),r=d.options.events.map,o=r.mouse,n=r.extra;r.state.forEach(function(r){e.on(r,function(o){var n=l(e,"map:"+r,o);t.dispatchEvent(n)})}),o.forEach(function(r){e.on(r,function(e){var o=new CustomEvent("map:"+r,{detail:{point:e.latlng},_leafletEvent:e});t.dispatchEvent(o)})}),n.includes("ready")&&e.whenReady(function(){var r=l(e,"map:ready");t.dispatchEvent(r)})}(s),this.map=s,s}},p=d.getTarget("map");function h(e,t,r,o,n){if(d.options.events.geometry.state.includes("add")){var a=new CustomEvent("geometry:"+e,{detail:{id:r,geometryType:o,target:n}});p.dispatchEvent(a)}}var y=["reverseOrder"],m=function(e){var t,r=e.geometryType,o=e.style,n=e.popup,a=e.tooltip,i=e.id,s=d.options.styles;return{geometry:function(e){if("string"==typeof e)try{return JSON.parse(e)}catch(e){return console.warn("Failed to parse the geometry string."),null}return null}(e.geometry),geometryType:r,options:{style:null==s||null==(t=s[r])?void 0:t[o],popup:n,tooltip:a,id:i}}},v={types:{point:{create:function(e,t,r){return o.marker(e,t)},update:function(e,t){return e.setLatLng(t)},convert:function(e,t){return t?[].concat(e).reverse():e},eventType:"mono"},linestring:{create:function(e,t,r){return o.polyline(e,t)},update:function(e,t){return e.setLatLngs(t)},convert:function(e,t){return t?o.GeoJSON.coordsToLatLngs(e,0):e},eventType:"poly"},polygon:{create:function(e,t,r){return o.polygon(e,t)},update:function(e,t){return e.setLatLngs(t)},convert:function(e,t){return t?o.GeoJSON.coordsToLatLngs(e,1):e},eventType:"poly"}},addType:function(e,t){if(!t.create||!t.update||!t.convert)throw new Error("Invalid handlers provided.");this.types[e]=t},shouldReverseCoordinates:function(e,t){return e||void 0!==t},applyPopupAndTooltip:function(e,t){t.popup&&e.bindPopup(t.popup),t.tooltip&&e.bindTooltip(t.tooltip)},createGeometry:function(e){var t=e.reverseOrder,r=function(e,t){if(null==e)return{};var r,o,n={},a=Object.keys(e);for(o=0;o<a.length;o++)t.indexOf(r=a[o])>=0||(n[r]=e[r]);return n}(e,y),o=d.options.reverseCoordinateOrder,n=m(e),a=n.geometry,i=n.geometryType,s=n.options,u=this.types[i.toLowerCase()],l=this.shouldReverseCoordinates(o,t);if(!u)throw new Error("Invalid geometry type: "+i);var c=u.convert(a,l),f=u.create(c,s.style,r);return this.applyPopupAndTooltip(f,s),function(e,t,r){if(d.options.events.geometry.mouse.includes("click"))if("mono"===r)e.on("click",function(r){var o=new CustomEvent("geometry:click",{detail:{clickedPoint:r.latlng,geometry:e.getLatLng(),id:t}});p.dispatchEvent(o)});else{if("poly"!==r)throw new Error("Invalid event type");e.on("click",function(r){var o=new CustomEvent("geometry:click",{detail:{clickedPoint:r.latlng,geometry:e.getLatLngs(),id:t}});p.dispatchEvent(o)})}}(f,s.id,u.eventType),f},updateGeometry:function(e,t){var r=this.shouldReverseCoordinates(d.options.reverseCoordinateOrder,t.reverseOrder),o=m(t),n=o.geometry,a=o.geometryType,i=this.types[a.toLowerCase()];if(!i)throw new Error("Invalid geometry type: "+a);var s=i.convert(n,r);return i.update(e,s)}},g={control:o.control.layers(),layerGroups:{},addBaseLayer:function(e,t){this.control.addBaseLayer(e,t)},getLayerGroup:function(e){var t;return null==(t=this.layerGroups)?void 0:t[e]},createLayerGroup:function(e){var t=o.layerGroup();return this.layerGroups[e]=t,this.control.addOverlay(t,e),t},deleteLayerGroup:function(e,t){if(void 0===t&&(t={ifEmpty:!1}),!t.ifEmpty||!this.layerGroups[e].getLayers().length){var r=this.layerGroups[e];delete this.layerGroups[e],this.control.removeLayer(r)}}},b={_tileLayers:{OpenStreetMap:o.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}),EsriWorldImagery:o.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community"})},_addTileLayer:function(e,t){var r=void 0===t?{}:t;if(!this._tileLayers[e]){var n=new o.TileLayer(r.url,{minZoom:r.minZoom||0,maxZoom:r.maxZoom||18,tms:!!r.tms});this._tileLayers[e]=n.tile}},_getDefaultHyperleafletTile:function(e){var t=e.find(function(e){return"defaultTile"in e.dataset});return t&&t.dataset.tile in this._tileLayers?this._tileLayers[t.dataset.tile]:e.length&&e[0].dataset.tile in this._tileLayers?this._tileLayers[e[0].dataset.tile]:this._tileLayers.OpenStreetMap},tiles:[],defaultTile:void 0,nodesToTiles:function(e){var t=this,r=Array.from(e);return r.forEach(function(e){var r=e.dataset.tile;if(!(r in t._tileLayers)){var o=e.dataset;t._addTileLayer(r,{tileUrl:o.tileUrl,tms:o.tms,minZoom:o.minZoom,maxZoom:o.maxZoom})}t.tiles.push({name:r,tile:t._tileLayers[r]})}),this.defaultTile=this._getDefaultHyperleafletTile(r),{defaultTile:this.defaultTile,tiles:this.tiles}}},N="[data-hyperleaflet-source]",E={beforeNodeAdd:[],afterNodeAdd:[],beforeNodeRemove:[],afterNodeRemove:[],beforeNodeChange:[],afterNodeChange:[],addNode:[],removeNode:[],changeNode:[],initialize:function(e){this.map=f.create(e),this.initializeLayerControl(e,this.map),this.initializeHyperleafletDataSource(),function(e){if(d.options.events.hyperleaflet.state.includes("ready")){var t=e.getBounds(),r=t.getSouthWest(),o=t.getNorthEast(),n=t.toBBoxString(),a=new CustomEvent("hyperleaflet:ready",{detail:{zoom:e.getZoom(),center:e.getCenter(),bbox:{min:r,max:o},bboxString:n}});window.dispatchEvent(a)}}(this.map)},addExtension:function(e){e.layer&&g.control.addOverlay(e.layer),e.addNode&&"function"==typeof e.addNode&&this.addNode.push(function(t){return e.addNode(t)}),e.removeNode&&"function"==typeof e.removeNode&&this.removeNode.push(function(t){return e.removeNode(t)}),e.changeNode&&"function"==typeof e.changeNode&&this.changeNode.push(function(t){return e.changeNode(t)}),e.beforeNodeAdd&&"function"==typeof e.beforeNodeAdd&&this.beforeNodeAdd.push(function(t){return e.beforeNodeAdd(t)}),e.afterNodeAdd&&"function"==typeof e.afterNodeAdd&&this.afterNodeAdd.push(e.afterNodeAdd),e.beforeNodeRemove&&"function"==typeof e.beforeNodeRemove&&this.beforeNodeRemove.push(e.beforeNodeRemove),e.afterNodeRemove&&"function"==typeof e.afterNodeRemove&&this.afterNodeRemove.push(e.afterNodeRemove),e.beforeNodeChange&&"function"==typeof e.beforeNodeChange&&this.beforeNodeChange.push(e.beforeNodeChange),e.afterNodeChange&&"function"==typeof e.afterNodeChange&&this.afterNodeChange.push(e.afterNodeChange)},initializeHyperleafletDataSource:function(){var e=this,t=document.querySelector(N);if(t){var r,o,n=(r=this.map,o=g,{addNodeToHyperleaflet:function(e){var t=e.dataset,n=e.dataset,a=n.layerName,i=n.id,s=r;if(a){var u=o.getLayerGroup(a);u?s=u:(s=o.createLayerGroup(a)).addTo(r)}var d=v.createGeometry(t);h("add",0,i,t.geometryType,s),d.hlID=i,d.addTo(s)},deleteNodeFromHyperleaflet:function(e){var t=e.dataset.id,n=e.dataset.layerName,a=o.getLayerGroup(n)||r,i=Object.values(a._layers).find(function(e){return e.hlID===t});a.removeLayer(i),h("remove",0,t,e.dataset.geometryType,a),o.deleteLayerGroup(n,{ifEmpty:!0})},changeNodeInHyperleaflet:function(e){var t=e["data-id"],o=Object.values(r._layers).find(function(e){return e.hlID===t});if("data-geometry"===e.attribute)return h("change",0,t,e.dataset.geometryType,r),v.updateGeometry(o,e.dataset);throw new Error("Parameter is not a number!")}}),i=n.addNodeToHyperleaflet,s=n.deleteNodeFromHyperleaflet,u=n.changeNodeInHyperleaflet;this.map.whenReady(function(){t.querySelectorAll("[data-id]").forEach(function(t){e.beforeNodeAdd.forEach(function(e){return e(t)}),t.dataset.hyperleafletExtension?e.addNode.forEach(function(e){return e(t)}):i(t),e.afterNodeAdd.forEach(function(e){return e(t)})})}),a.observe({targetSelector:N,uniqueAttribute:"data-id",attributeFilter:["data-geometry"]}),a.subscribe(N,"node_adds",function(t){t.forEach(function(t){e.beforeNodeAdd.forEach(function(e){return e(t)}),t.dataset.hyperleafletExtension?e.addNode.forEach(function(e){return e(t)}):i(t),e.afterNodeAdd.forEach(function(e){return e(t)})})}),a.subscribe(N,"node_removes",function(t){t.forEach(function(t){e.beforeNodeRemove.forEach(function(e){return e(t)}),t.dataset.hyperleafletExtension?e.removeNode.forEach(function(e){return e(t)}):s(t),e.beforeNodeRemove.forEach(function(e){return e(t)})})}),a.subscribe(N,"node_changes",function(t){t.forEach(function(t){e.afterNodeChange.forEach(function(e){return e(t)}),t.dataset.hyperleafletExtension?e.changeNode.forEach(function(e){return e(t)}):u(t),e.afterNodeChange.forEach(function(e){return e(t)})})})}},initializeLayerControl:function(e){var t=e.querySelectorAll("[data-tile]"),r=b.nodesToTiles(t),o=r.defaultTile,n=r.tiles;g.control.addTo(this.map),n.forEach(function(e){g.addBaseLayer(e.tile,e.name)}),o.addTo(this.map)},addGeometryType:function(e,t){v.addType(e,t)}};E.options=d.options,document.addEventListener("DOMContentLoaded",function(){E.initialize(document.querySelector(d.options.mapElement))}),window.hyperleaflet=E,e.hyperleaflet=E});
//# sourceMappingURL=hyperleaflet.js.map
