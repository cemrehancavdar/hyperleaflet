!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("leaflet")):"function"==typeof define&&define.amd?define(["exports","leaflet"],t):t((e||self).hyperleaflet={},e.leaflet)}(this,function(e,t){function r(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(r){if("default"!==r){var o=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,o.get?o:{enumerable:!0,get:function(){return e[r]}})}}),t.default=e,t}var o=/*#__PURE__*/r(t);function n(){return n=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},n.apply(this,arguments)}function a(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,o=new Array(t);r<t;r++)o[r]=e[r];return o}var i={events:{},observe:function(e){var t=e.targetSelector,r=e.uniqueAttribute,o=e.attributeFilter;if(this.events[t])throw new Error("Can't observe the same target twice");!function(e,t,r){function o(e){var r=[];return e.forEach(function(e){1===e.nodeType&&(e.hasAttribute(t)&&r.push(e),r.push.apply(r,o(e.childNodes)))}),r}var a=new MutationObserver(function(a){var u=[],s=[];a.forEach(function(r){if("childList"===r.type)u.push.apply(u,o(r.removedNodes)),s.push.apply(s,o(r.addedNodes));else if("attributes"===r.type){var a,d=r.attributeName,l=((a={attribute:d,from:r.oldValue,to:r.target.getAttribute(d)})[t]=r.target.getAttribute(t),a),c=[n({dataset:r.target.dataset},l)];i.publish(e,"node_changes",c)}});var d=[],l=new Map(u.map(function(e){return[e.getAttribute(t),e]})),c=new Set;s.forEach(function(e){var o=e.getAttribute(t),a=l.get(o);if(a&&c.add(o),a&&!function(e,t,r){return r.every(function(r){return e.getAttribute(r)===t.getAttribute(r)})}(a,e,r)){var i=r.reduce(function(r,n){var i,u=a.getAttribute(n),s=e.getAttribute(n);return u!==s&&r.push(((i={attribute:n,from:u,to:s})[t]=o,i)),r},[]);d.push(n({},i,{dataset:e.dataset}))}});var f=u.filter(function(e){return!c.has(e.getAttribute(t))}),p=s.filter(function(e){return!c.has(e.getAttribute(t))});p.length&&i.publish(e,"node_adds",p),d.length&&i.publish(e,"node_changes",d),f.length&&i.publish(e,"node_removes",f)}),u=document.querySelector(e);a.observe(u,{childList:!0,subtree:!0,attributes:!0,attributeFilter:r,attributeOldValue:!0})}(t,r,o),this.events[t]={}},subscribe:function(e,t,r){this.events[e][t]=this.events[e][t]||[],this.events[e][t].push(r)},unsubscribe:function(e,t,r){this.events[e][t]&&(this.events[e][t]=this.events[e][t].filter(function(e){return e!==r}))},publish:function(e,t,r){this.events[e][t]&&this.events[e][t].forEach(function(e){return e(r)})}};function u(e){return e&&"object"==typeof e&&!Array.isArray(e)}function s(e,t){var r=n({},e);return u(e)&&u(t)&&Object.keys(t).forEach(function(o){r[o]=u(t[o])&&o in e&&u(e[o])?s(e[o],t[o]):t[o]}),r}var d={reverseCoordinateOrder:!1,mapElement:"#map",events:{target:"window",map:{click:!0,dblclick:!1,mousedown:!1,mouseover:!1,mousemove:!1,mouseout:!1,contextmenu:!1,preclick:!1,zoom:!0,move:!0,zoomstart:!1,zoomend:!1,movestart:!1,moveend:!1,ready:!0},geometry:{click:!0,move:!1,add:!1},hyperleaflet:{ready:!0}},styles:{}},l={_hyperleaflet:null,_options:d,get options(){return this._options},set options(e){this._options=s(this._options,e)},reset:function(){this._options=d},getTarget:function(){switch(this.options.events.target){case"window":return window;case"document":return document;default:return this._hyperleaflet}}};function c(e,t,r){var o=e.getBounds(),n=o.getSouthWest(),a=o.getNorthEast(),i=o.toBBoxString();return new CustomEvent(t,{detail:{zoom:e.getZoom(),center:e.getCenter(),bbox:{min:n,max:a},bboxString:i,_leafletEvent:r}})}var f=["zoomstart","zoomend","movestart","moveend","zoom","move"],p=["click","dblclick","mousedown","mouseover","mouseout","mousemove","contextmenu","preclick"];function y(e,t){void 0===t&&(t=!1);try{var r=JSON.parse(e);return t?function(e){return e.reverse()}(r):r}catch(e){return[0,0]}}function h(e,t,r,o,n){var a=l.getTarget("map");if(l.options.events.geometry.add){var i=new CustomEvent("geometry:"+e,{detail:{id:r,geometryType:o,target:n}});a.dispatchEvent(i)}}var m,v,g=["reverseOrder"],b=function(e){var t,r=e.geometryType,o=e.style,n=e.popup,a=e.tooltip,i=e.id,u=l.options.styles;return{geometry:function(e){if("string"==typeof e)try{return JSON.parse(e)}catch(e){return console.warn("Failed to parse the geometry string."),null}return null}(e.geometry),geometryType:r,options:{style:null==u||null==(t=u[r])?void 0:t[o],popup:n,tooltip:a,id:i}}},E={types:{point:{create:function(e,t,r){return o.marker(e,t)},update:function(e,t){return e.setLatLng(t)},convert:function(e,t){return t?[].concat(e).reverse():e},eventType:"mono"},linestring:{create:function(e,t,r){return o.polyline(e,t)},update:function(e,t){return e.setLatLngs(t)},convert:function(e,t){return t?o.GeoJSON.coordsToLatLngs(e,0):e},eventType:"poly"},polygon:{create:function(e,t,r){return o.polygon(e,t)},update:function(e,t){return e.setLatLngs(t)},convert:function(e,t){return t?o.GeoJSON.coordsToLatLngs(e,1):e},eventType:"poly"}},addType:function(e,t){if(!t.create||!t.update||!t.convert)throw new Error("Invalid handlers provided.");this.types[e]=t},shouldReverseCoordinates:function(e,t){return e||void 0!==t},applyPopupAndTooltip:function(e,t){t.popup&&e.bindPopup(t.popup),t.tooltip&&e.bindTooltip(t.tooltip)},createGeometry:function(e){var t=e.reverseOrder,r=function(e,t){if(null==e)return{};var r,o,n={},a=Object.keys(e);for(o=0;o<a.length;o++)t.indexOf(r=a[o])>=0||(n[r]=e[r]);return n}(e,g),o=l.options.reverseCoordinateOrder,n=b(e),a=n.geometry,i=n.geometryType,u=n.options,s=this.types[i.toLowerCase()],d=this.shouldReverseCoordinates(o,t);if(!s)throw new Error("Invalid geometry type: "+i);var c=s.convert(a,d),f=s.create(c,u.style,r);return this.applyPopupAndTooltip(f,u),function(e,t,r){var o=l.getTarget("map");if(l.options.events.geometry.click)if("mono"===r)e.on("click",function(r){var n=new CustomEvent("geometry:click",{detail:{clickedPoint:r.latlng,geometry:e.getLatLng(),id:t}});o.dispatchEvent(n)});else{if("poly"!==r)throw new Error("Invalid event type");e.on("click",function(r){var n=new CustomEvent("geometry:click",{detail:{clickedPoint:r.latlng,geometry:e.getLatLngs(),id:t}});o.dispatchEvent(n)})}}(f,u.id,s.eventType),f},updateGeometry:function(e,t){var r=this.shouldReverseCoordinates(l.options.reverseCoordinateOrder,t.reverseOrder),o=b(t),n=o.geometry,a=o.geometryType,i=this.types[a.toLowerCase()];if(!i)throw new Error("Invalid geometry type: "+a);var u=i.convert(n,r);return i.update(e,u)}},T={control:o.control.layers(),layerGroups:{},addBaseLayer:function(e,t){this.control.addBaseLayer(e,t)},getLayerGroup:function(e){var t;return null==(t=this.layerGroups)?void 0:t[e]},createLayerGroup:function(e){var t=o.layerGroup();return this.layerGroups[e]=t,this.control.addOverlay(t,e),t},deleteLayerGroup:function(e,t){if(void 0===t&&(t={ifEmpty:!1}),!t.ifEmpty||!this.layerGroups[e].getLayers().length){var r=this.layerGroups[e];delete this.layerGroups[e],this.control.removeLayer(r)}}},L={_tileLayers:{OpenStreetMap:o.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}),EsriWorldImagery:o.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community"})},_addTileLayer:function(e,t){var r=void 0===t?{}:t,n=r.minZoom,a=r.maxZoom;if(!this._tileLayers[e]){var i=new o.TileLayer(r.url,{minZoom:void 0===n?0:n,maxZoom:void 0===a?18:a,tms:!!r.tms});this._tileLayers[e]=i}},_getDefaultHyperleafletTile:function(e){var t=e.find(function(e){return"defaultTile"in e.dataset});return t&&t.dataset.tile in this._tileLayers?this._tileLayers[t.dataset.tile]:e.length&&e[0].dataset.tile in this._tileLayers?this._tileLayers[e[0].dataset.tile]:this._tileLayers.OpenStreetMap},tiles:[],defaultTile:void 0,nodesToTiles:function(e){var t=this,r=Array.from(e);return r.forEach(function(e){var r=e.dataset.tile;if(!(r in t._tileLayers)){var o=e.dataset;t._addTileLayer(r,{url:o.tileUrl,tms:o.tms,minZoom:o.minZoom,maxZoom:o.maxZoom})}t.tiles.push({name:r,tile:t._tileLayers[r]})}),this.defaultTile=this._getDefaultHyperleafletTile(r),{defaultTile:this.defaultTile,tiles:this.tiles}}},w="[data-hyperleaflet-source]",N={beforeNodeAdd:[],afterNodeAdd:[],beforeNodeRemove:[],afterNodeRemove:[],beforeNodeChange:[],afterNodeChange:[],addNode:[],removeNode:[],changeNode:[],customMapEvents:[],initialize:function(e){var t=this;if(e){e.setAttribute("hyperleaflet","");var r=function(e){var t=l,r=e.dataset.mapConfig,n=r?document.querySelector(r):e;if(!n)throw new Error("No map config found");var a,i,u,s=n.dataset,d=s.zoom,h=s.minZoom,m=s.maxZoom,v={center:y(s.center,t.options.reverseCoordinateOrder),zoom:d||1},g=o.map(e,{center:v.center,zoom:v.zoom,minZoom:h||0,maxZoom:m||18});return a=g,i=l.getTarget("map"),u=l.options.events.map,Object.entries(u).forEach(function(e){var t=e[0];e[1]&&(f.includes(t)&&a.on(t,function(e){var r=c(a,"map:"+t,e);i.dispatchEvent(r)}),p.includes(t)&&a.on(t,function(e){var r=new CustomEvent("map:"+t,{detail:{point:e.latlng},_leafletEvent:e});i.dispatchEvent(r)}))}),u.ready&&a.whenReady(function(){var e=c(a,"map:ready");i.dispatchEvent(e)}),[g,n]}(e),n=r[1];this.map=r[0],this.target=n,this.initializeLayerControl(e,this.map),this.initializeHyperleafletDataSource(),this.customMapEvents.forEach(function(e){return e(t.map,t.target)}),function(e){var t=l.getTarget("hyperleaflet");if(l.options.events.hyperleaflet.ready){var r=e.getBounds(),o=r.getSouthWest(),n=r.getNorthEast(),a=r.toBBoxString(),i=new CustomEvent("hyperleaflet:ready",{detail:{zoom:e.getZoom(),center:e.getCenter(),bbox:{min:o,max:n},bboxString:a}});t.dispatchEvent(i)}}(this.map)}else console.warn("Hyperleaflet: No map container found.")},addExtension:function(e){var t=this;e.layer&&T.control.addOverlay(e.layer),e.handleMap&&this.customMapEvents.push(function(t,r){return e.handleMap(t,r)}),["addNode","removeNode","changeNode","beforeNodeAdd","afterNodeAdd","beforeNodeRemove","afterNodeRemove","beforeNodeChange","afterNodeChange"].forEach(function(r){e[r]&&"function"==typeof e[r]&&t[r].push(function(t){return e[r](t)})})},initializeHyperleafletDataSource:function(){var e=this,t=document.querySelector(w);if(t){var r,o,n=(r=this.map,o=T,{addNodeToHyperleaflet:function(e){var t=e.dataset,n=e.dataset,a=n.layerName,i=n.id,u=r;if(a){var s=o.getLayerGroup(a);s?u=s:(u=o.createLayerGroup(a)).addTo(r)}var d=E.createGeometry(t);h("add",0,i,t.geometryType,u),d.hlID=i,d.addTo(u)},deleteNodeFromHyperleaflet:function(e){var t=e.dataset.id,n=e.dataset.layerName,a=o.getLayerGroup(n)||r,i=Object.values(a._layers).find(function(e){return e.hlID===t});a.removeLayer(i),h("remove",0,t,e.dataset.geometryType,a),o.deleteLayerGroup(n,{ifEmpty:!0})},changeNodeInHyperleaflet:function(e){var t=e["data-id"],o=Object.values(r._layers).find(function(e){return e.hlID===t});if("data-geometry"===e.attribute)return h("change",0,t,e.dataset.geometryType,r),E.updateGeometry(o,e.dataset);throw new Error("Unsupported attribute change!")}}),a=n.addNodeToHyperleaflet,u=n.deleteNodeFromHyperleaflet,s=n.changeNodeInHyperleaflet;this.map.whenReady(function(){t.querySelectorAll("[data-id]").forEach(function(t){e.beforeNodeAdd.forEach(function(e){return e(t)}),t.dataset.hyperleafletExtension?e.addNode.forEach(function(e){return e(t)}):a(t),e.afterNodeAdd.forEach(function(e){return e(t)})})}),i.observe({targetSelector:w,uniqueAttribute:"data-id",attributeFilter:["data-geometry"]}),i.subscribe(w,"node_adds",function(t){t.forEach(function(t){e.beforeNodeAdd.forEach(function(e){return e(t)}),t.dataset.hyperleafletExtension?e.addNode.forEach(function(e){return e(t)}):a(t),e.afterNodeAdd.forEach(function(e){return e(t)})})}),i.subscribe(w,"node_removes",function(t){t.forEach(function(t){e.beforeNodeRemove.forEach(function(e){return e(t)}),t.dataset.hyperleafletExtension?e.removeNode.forEach(function(e){return e(t)}):u(t),e.afterNodeRemove.forEach(function(e){return e(t)})})}),i.subscribe(w,"node_changes",function(t){t.forEach(function(t){e.beforeNodeChange.forEach(function(e){return e(t)}),t.dataset.hyperleafletExtension?e.changeNode.forEach(function(e){return e(t)}):s(t),e.afterNodeChange.forEach(function(e){return e(t)})})})}},initializeLayerControl:function(e){var t=e.querySelectorAll("[data-tile]"),r=L.nodesToTiles(t),o=r.defaultTile,n=r.tiles;T.control.addTo(this.map),n.forEach(function(e){T.addBaseLayer(e.tile,e.name)}),o.addTo(this.map)},getZoom:function(){return this.map.getZoom()},setZoom:function(e){this.map.setZoom(e)},getCenter:function(){return this.map.getCenter()},fitBounds:function(e){this.map.fitBounds(e)},getBounds:function(){return this.map.getBounds()},getBBoxString:function(){return this.map.getBounds().toBBoxString()},panTo:function(e){this.map.panTo(e)},flyTo:function(e,t){void 0===t&&(t=void 0),t=t||this.map.getZoom(),this.map.flyTo(e,t)},flyToBounds:function(e){this.map.flyToBounds(e)}};function A(){var e=document.querySelector(l.options.mapElement);return!!e&&(N.initialize(e),!0)}N.addGeometryType=function(e,t){E.addType(e,t)},m=N,v={},Object.assign(m,{addEventListener:function(e,t){e in v||(v[e]=[]),v[e].push(t)},removeEventListener:function(e,t){if(e in v){var r=v[e].indexOf(t);-1!==r&&v[e].splice(r,1)}},dispatchEvent:function(e){if(!(e.type in v))return!0;for(var t,r=function(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return(r=r.call(e)).next.bind(r);if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return a(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?a(e,t):void 0}}(e))){r&&(e=r);var o=0;return function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(v[e.type].slice());!(t=r()).done;)t.value.call(m,e);return!e.defaultPrevented}}),N.config=l,l._hyperleaflet=N,document.addEventListener("DOMContentLoaded",function(){A()||new MutationObserver(function(e,t){A()&&t.disconnect()}).observe(document.body,{childList:!0,subtree:!0})}),window.hyperleaflet=N,e.hyperleaflet=N});
//# sourceMappingURL=hyperleaflet.umd.js.map
